---
title: "04_Wenas_meta_stats"
output:
  html_document: default
  word_document: default
  pdf_document: default
date: "2023-07-11"
editor_options:
  chunk_output_type: console
---

## Load packages and set working directory
```{r Jake/Mac}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment


library(tidyverse)
library(rstatix)
library(ggpubr)
library(ggplot2)
library(coin)
library(dotwhisker)
library(dplyr)
library(lme4)
library(emmeans)
library(lmerTest)

```


### STEP 1 load in the data and normalize data ###
```{r Metadata Google Sheet Import}
#import Metadata sheet that is stored on Google Sheet 
percent_difference <- read_csv("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/Output_for_analysis/analyte_table_DOC_no3.csv")

# log transform the percentages 
percent_difference <- percent_difference %>% 
  mutate(log_pd = log(abs(Percent_Difference))) # should I be taking the absolute value of the negative percent_differences?

percent_difference_DOC <- percent_difference %>% 
  filter(response_var == "DOC_mg_C_L")

percent_difference_NO3 <- percent_difference %>% 
  filter(response_var == "NO3_mg_per_L_as_Nitrate")

```

### STEP 2 check normality for DOC ###
```{r DOC}
summary(percent_difference_DOC$Percent_Difference)

#Visualize data
ggboxplot(percent_difference_DOC$Percent_Difference, 
          ylab = "Percent Difference (%)", xlab = FALSE,
          ggtheme = theme_minimal())


#perform shapiro-wilk test
shapiro.test(percent_difference_DOC$Percent_Difference)

# checking to see if the data is normal 
ggqqplot(percent_difference_DOC$Percent_Difference, ylab = "Percent Difference",
         ggtheme = theme_minimal())

# p-value is greater than 0.05 which indicates that the data is normally distributed

```

The percent differences for DOC are already normally distributed and do NOT need to be transformed. 

### STEP 3 perform t-test for DOC ###
```{r one-sample t-test DOC}
# 
res <- t.test(percent_difference_DOC$Percent_Difference, mu = 0)
# printing the results
res

```
t is the test-statistic value (t=4.0412)
df is the degrees of freedom (df = 30)
p-value is the significance level of the t-test (p-value = 0.0003409)
conf.int is the confidence interval of the mean at 95% ([17.14,52.16])
sample estimates is the mean value of the sample (mean = 34.65)

The p-value of the test is 0.0003409, which is less than the significance level alpha = 0.05. We can conclude that the mean percent difference for DOC is significantly different from 0%. 

### STEP 4 do the same thing for nitrate  ###

```{r NO3}
###  check normality for NO3 ###
summary(percent_difference_NO3$Percent_Difference)

#Visualize data
ggboxplot(percent_difference_NO3$Percent_Difference, 
          ylab = "Percent Difference (%)", xlab = FALSE,
          ggtheme = theme_minimal())


#perform shapiro-wilk test
shapiro.test(percent_difference_NO3$Percent_Difference)

# p-value is less than 0.05 which indicates that the data is normally distributed


# checking to see if the data is normal 
ggqqplot(percent_difference_NO3$Percent_Difference, ylab = "Percent Difference",
         ggtheme = theme_minimal())
```

The percent differences for nitrate do not appear to be normally distributed so lets do a log transform 

```{r log transform for NO3}
#perform shapiro-wilk test
shapiro.test(percent_difference_NO3$log_pd)

# p-value is less than 0.05 which indicates that the data is normally distributed


# checking to see if the data is normal 
ggqqplot(percent_difference_NO3$log_pd, ylab = "Percent Difference",
         ggtheme = theme_minimal())
```
I don't think this looks better than the non-log transformed. What should we go with here?


```{r one-sample t-test NO3}
# 
res <- t.test(percent_difference_NO3$Percent_Difference, mu = 0)
# printing the results
res

```
t is the test-statistic value (t = 6.5941)
df is the degrees of freedom (df = 47)
p-value is the significance level of the t-test (p-value = 3.378e-08)
conf.int is the confidence interval of the mean at 95% ([124.93,234.63])
sample estimates is the mean value of the sample (mean = 179.7861)

The p-value of the test is 3.378e, which is less than the significance level alpha = 0.05. We can conclude that the mean percent difference for NO3 is significantly different from 0%. 




#### STEP 5 Do CIs of effect size overlap with 0 #### 
This will tell us if the effect sizes are significant or not 
```{r}
rm(list=ls(all=T)) #this clears your Environment


library(tidyverse)
library(rstatix)
library(ggpubr)
library(ggplot2)
library(coin)
library(dotwhisker)

effect_size <- read_csv("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/Output_for_analysis/analyte_table_effect_DOC_no3.csv")

effect_size_DOC <- effect_size %>% 
  filter(response_var == "DOC_mg_C_L")

effect_size_NO3 <- effect_size %>% 
  filter(response_var == "NO3_mg_per_L_as_Nitrate")

# Calculating the average effect size per study_ID and the standard deviation:
study_id_summary <- effect_size %>%
  group_by(Study_ID, response_var) %>%
  summarise(
    MeanEffect = mean(Effect_size),
    sd = sd(Effect_size, na.rm = TRUE))


```

### I want to see the relationship between the effect size and percent change that Peter looked at really quickly with the Dove paper ### 
```{r}
# relationship between effect size and percent change 
percent_difference %>% 
  count(Study_ID)
effect_size %>% 
  count(Study_ID)

es <- effect_size %>% 
  filter(!row_number() %in% c(37))
  
pd_es <- percent_difference %>% 
  select("Study_ID", "response_var", "Percent_Difference") %>% 
  mutate(Effect_Size = paste(es$Effect_size))

ggplot(pd_es) +
  geom_point(aes(x = Percent_Difference, y = as.numeric(Effect_Size), color = "red")) +
  facet_wrap(~response_var) +
  theme_bw()



```
The equation for percent change in Dove's paper is D = 100(1-e^ln(R))

This looks like a log relationship so is there where they get that equation for the relationship between effect size and percent change...

### CALCULATING CI ###
```{r}
# Calculating a confidence interval for all of the effect sizes
# calculating the mean effect_size by climate
climate_summary_effect <- effect_size %>%
  group_by(Koppen, response_var, Climate) %>%
  summarise(sd_effect = sd(Effect_size, na.rm = TRUE),
            n_effect = n(),
            Effect_size = mean(Effect_size, na.rm = TRUE)) %>% 
 mutate(se_effect = sd_effect / sqrt(n_effect),
         lower_ci_effect = Effect_size - qt(1 - (0.05 / 2), n_effect - 1) * se_effect,
         upper_ci_effect = Effect_size + qt(1 - (0.05 / 2), n_effect - 1) * se_effect)
 
 

# Calculating a confidence interval for all of the effect sizes
# calculating the mean effect_size by climate
TSF_summary_effect <- effect_size %>%
  group_by(TSF, response_var) %>%
  summarise(sd_effect = sd(Effect_size, na.rm = TRUE),
            n_effect = n(),
            Effect_size = mean(Effect_size, na.rm = TRUE)) %>% 
 mutate(se_effect = sd_effect / sqrt(n_effect),
         lower_ci_effect = Effect_size - qt(1 - (0.05 / 2), n_effect - 1) * se_effect,
         upper_ci_effect = Effect_size + qt(1 - (0.05 / 2), n_effect - 1) * se_effect)


```

### PLOTS ###
```{r}
### Plotting ###

# Ploting #
vn = expression(paste(""*N*O[3]^"-"))

# geom_jitter for climate # 
ggplot(effect_size, aes(Effect_size, Koppen, color = response_var),
       position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4, size = 1) +
  geom_pointrange(aes(xmin = lower_ci_effect, xmax = upper_ci_effect, 
                      color = response_var),
                      position = position_dodge(width = -0.5), size = 1.0, data = climate_summary_effect) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  ylab("Koppen (Climate Classification)") +
  xlab("Effect Size (ln[R])") +
  ggtitle("95% CI of Effect Size") +
  geom_segment(aes(x = 5.5, xend = 5.5, y = 6.5, yend = 4.5), color = "black") +
  geom_segment(aes(x = 4.75, xend = 5.5, y = 6.5, yend = 6.5), color = "black") +
  geom_segment(aes(x = 4.75, xend = 5.5, y = 4.5, yend = 4.5), color = "black") +
  
  geom_segment(aes(x = 5.5, xend = 5.5, y = 4.3, yend = 1.5), color = "black") +
  geom_segment(aes(x = 4.75, xend = 5.5, y = 4.3, yend = 4.3), color = "black") +
  geom_segment(aes(x = 4.75, xend = 5.5, y = 1.5, yend = 1.5), color = "black") +
   
  geom_segment(aes(x = 5.5, xend = 5.5, y = 1.3, yend = 0.5), color = "black") +
  geom_segment(aes(x = 4.75, xend = 5.5, y = 1.3, yend = 1.3), color = "black") +
  geom_segment(aes(x = 4.75, xend = 5.5, y = 0.5, yend = 0.5), color = "black") +
  annotate("text",
           x = c(6.1, 6.1, 6.1),
           y = c(5.5, 3, 1),
           label = c("Cold", "Temperate", "Arid"),
           family = "", fontface = "bold") +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text = element_text(size = 15),
        legend.position = c(0.1, 0.15),
        title = element_text(size = 10))

ggsave("site.effect.geom_pointrange.climate.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/03_Wenas_effect_size"),
       width = 10, height = 8, units = "in")


# geom_jitter for TSF # 
# Creating an order in which I want to plot the y-axis
level_order <- c('0-1 years', '2-3 years', '4-5 years', '>10 years') 

ggplot(effect_size, aes(Effect_size, TSF, color = response_var)) +
  geom_jitter(position = position_jitter(0.2), alpha = 0.4, size = 1) +
  geom_pointrange(aes(xmin = lower_ci_effect, xmax = upper_ci_effect, 
                      color = response_var),
                      position = position_dodge(width = -0.5), size = 1.0, data = TSF_summary_effect) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  scale_y_discrete(limit = level_order) +
  xlab("Effect Size (ln[R])") +
  ggtitle("95% CI of Effect Size") +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 15),
        legend.position = c(0.2, 0.15),
        title = element_text(size = 10))

ggsave("site.difference.geom_pointrange.TSF.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/03_Wenas_effect_size"),
       width = 10, height = 8, units = "in")



### LIKE DOVE DOES IT ###
effect_size <- effect_size %>% 
  mutate(PD = abs(100*(1-exp(Effect_size)))) # calculating percent_difference 

# summary stats #
effect_size_summary <- effect_size %>% 
  group_by(TSF) %>% 
  summarise(meanPD = mean(PD))



ggplot(effect_size, aes(TSF, Effect_size, color = response_var)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red") + 
  scale_x_discrete(limit = level_order) +
  theme_classic()


```


### STEP 6 random effects model ###
```{r DOC random effects }
mDOC_climate <- lmer(Effect_size ~ Climate + (1|Study_ID), data = effect_size_DOC)
summary(mDOC_climate) 

plot(mDOC_climate)
qqnorm(resid(mDOC_climate))

anova(mDOC_climate) # f-value = 0.7755



```

Column standard deviation is a measure of how much variability in the dependent measure there is due to the Study_IDs (our random effects). You can see that the Study_ID is adding no additional variance. I think this would suggest that we can use a random intercept model for DOC. The random intercept framework (1|Study_ID) tells the model that it should expect that there are going to be multiple responses per Study_ID and these responses will depend on the Study_ID "baseline" This framework assumes that whatever the effect of effect_size is, its going to be the same for all Study_IDs and considering our variance is 0 I think this is a safe assumption. If this assumption/interpretation is wrong on my end than we can look at doing a random slopes structure which would look like lmer(effect_size ~ Climate + (1+Climate|Study_ID))

“Residual” which stands for the variability that’s not due to Study_ID. This is our “ε” again, the “random” deviations from the predicted values that are not due to Study_ID. 


```{r DOC random effects fire}
#emmeans(mDOC, list(pairwise ~ Study_ID), adjust = "tukey")

effect_size_DOC <- effect_size_DOC %>% 
  mutate(TSF_factor = factor(TSF, levels = c("0-1 years", "2-3 years", "4-5 years", ">10 years")))

# fire
mDOC_fire <- lmer(Effect_size ~ TSF_factor + (1|Study_ID), data = effect_size_DOC)

summary(mDOC_fire) # none are significant 

plot(mDOC_fire)
qqnorm(resid(mDOC_fire))

anova(mDOC_fire) # f-value = 0.9201

effect_size_DOC %>% 
  group_by(TSF) %>% 
  summarise(mean = mean(Effect_size))

#0-1 years 0.340
#2-3 years 0.261
#4-5 years 0.290
#>10 years 0.168



```

This is the model with TimeSinceFire rather than climate. It shows that Study_ID is still not adding a ton of variance. The T-value for 0-1 year is the highest meaning that its the most significant.


```{r NO3 random effects }
mNO3_climate <- lmer(Effect_size ~ Climate + (1|Study_ID), data = effect_size_NO3)

plot(mNO3_climate)
qqnorm(resid(mNO3_climate))

anova(mNO3_climate) # f-value = 0.5874

summary(mNO3_climate) 

```

The Study_ID does appear to be showing additional variance but not a lot still. It also doesn't appear that climate is having an effect on effect_Size of nitrate. 



```{r NO3 random effects fire}
effect_size_NO3 <- effect_size_NO3 %>% 
  mutate(TSF_factor = factor(TSF, levels = c("0-1 years", "2-3 years", "4-5 years", ">10 years")))

mNO3_TSF <- lmer(Effect_size ~ TSF_factor + (1|Study_ID), data = effect_size_NO3)
summary(mNO3_TSF) 

plot(mNO3_TSF)
qqnorm(resid(mNO3_TSF))

anova(mNO3_TSF) # f-value = 0.5874

summary(mNO3_TSF) 
```

The Study_ID does appear to be showing additional variance but not a lot still. Based on the t-values, 0-1 is maybe the most significant but it is small. 









############## Steph sent a meta analysis script in R and I want to test it here ###########
```{r}
library(metafor)
library(boot)
library(meta)

#
effect_size_DOC <- effect_size_DOC %>% 
  mutate(TSF_factor = factor(TSF, levels = c("0-1 years", "2-3 years", "4-5 years", ">10 years")))
# 

# pivoting to make the responses in one column
effect_size_DOC_long <- effect_size_DOC %>% 
  pivot_longer(
    cols = Xe1:Xe10,
    names_to = "Experimental",
    values_to = "mean_concentration",
    values_drop_na = TRUE
  )
effect_size_DOC_long <- effect_size_DOC_long[!duplicated(effect_size_DOC_long$mean_concentration), ]

ADGmetaHAKN_High_LS <-metacont(n.e = Ne,
                      mean.e = mean_concentration,
                      sd.e = mean_concentration, 
                      n.c = Nc,
                      mean.c = Xc, 
                      sd.c = Xc, 
                      studlab = Study_ID,
                      data = effect_size_DOC_long,
                      comb.fixed = FALSE,
                      comb.random = TRUE,
                      method.tau = "REML",
                      hakn=TRUE,
                      byvar = effect_size_DOC_long$TSF_factor,
                      tau.common = FALSE)

ADGmetaHAKN_High_LS

# plot #
forest(ADGmetaHAKN_High_LS,
       col.square = "green",
       col.square.lines = "green",
       col.diamond.random = "black",
       col.diamond.lines.random = "black",
       allstudies = TRUE,
       text.random = "Mean ADG",
       leftlabs=c("Study","N","Mean","SD","N","Mean","SD"),
       lab.e="B",
       lab.c="A",
       comb.fixed=FALSE,
       comb.random = TRUE,
       label.left="Favours A", 
       col.label.left="red",
       label.right="Favours B", 
       col.label.right="blue",
       hetstat=FALSE,
       test.overall.random = TRUE,
       digits.mean=2,
       digits.sd=2,
       digits.weight = 0,
       weight.study = "random",
       test.effect.subgroup.random = TRUE,
       overall = TRUE,
       print.byvar = FALSE,
       col.by="purple",
       addrow.subgroups=TRUE,
       addrow.overall=TRUE,
       addrow=TRUE,
       label.test.effect.subgroup.random="Subgroup effect",
       test.subgroup.random = TRUE)

```
























