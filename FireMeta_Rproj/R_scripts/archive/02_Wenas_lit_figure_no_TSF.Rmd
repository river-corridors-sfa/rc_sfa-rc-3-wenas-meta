---
title: "02_Wenas_lit_figure_no_TSF"
output: html_document
date: "2023-06-15"
editor_options: 
  chunk_output_type: console
---

The purpose of this script is do the same thing as 01_Wenas_lit_review_figure but without the TSF designation:

generate an output dataframe that is similar to Table 1 in Dove & Hart, 2017 (https://link.springer.com/article/10.4996/fireecology.130237746) that includes: 
Study_ID
Climate 
control replicates (Nc)
control mean (Xc)
experimental replicates (Ne)
experimental mean (Xe) 
the natural log of the response ratio (ln[R])
Percent change (percent_change)
Percent change standard deviation (percent_changeSD)
effect size standard deviation (EsSD)
Difference (Diff)
AND 
Difference standard deviation (DiffSD) 
FOR EACH STUDY_ID

We also want to create a figure showing the variability of percent change between sites that have been burned compared to their reference site that is listed in the study_ID grouped put by TSF 

Workflow:
Step 1) Load in meta data sheet from googledrive located in "Fire numerical modeling Paper->Background Figure_MEBandVGC->Wenas_modeling_Papers_use_for_Fig"

Step 2) Clean spreadsheet to filter only data that is needed 

Step 3) Group by study_ID and obtain values listed above

Step 4) Save output file as: in "enter_directory filepath"




## Load packages and set working directory
```{r Jake/Mac}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment

library(ggplot2)
library(googlesheets4)
library(tidyverse)
library(lubridate)
```


### STEP 1 load in the data and filter out what columns we want ### 
```{r Metadata Google Sheet Import}
#import Metadata sheet that is stored on Google Sheet 
metadata <- read_sheet("https://docs.google.com/spreadsheets/d/1S1-Aheu-BJiIybye95YQzRi_9e2kS-udcsKcsC7H8dk/edit#gid=0",col_types ='c')

#you may need OAuth access. Press 1 to grant access

# select the columns that I want 
metadata <- metadata %>% select("Study_ID", "Pair_JSC", "Climate_JSC_from_climatecharts.net", 
                       "Burn or Unburn", "Time_Since_Fire", "Time_Since_Fire_JSC",
                 "DOC_mg_C_L", "STDEV_DOC", "STER_DOC",
                 "TN_mg_N_per_L", "STDEV_TN", "STER_TN",
                 "TDN_mg_N_per_L", "STDEV_TDN", "STER_TDN",
                 "NO3_mg_per_L_as_Nitrate", "STDEV_NO3", "STER_NO3",
                 "NH4_mg_per_L_as_NH4", "STER_NH4")

# rename some of the columns 
metadata <- metadata %>% 
    rename("Treatment" = "Burn or Unburn",
           "Koppen" = "Climate_JSC_from_climatecharts.net") 


# substituting all greater than or less than characters out 
# metadata <- metadata %>% 
#   mutate_all(str_remove(.,"<"))

metadata <- as.data.frame(sapply(metadata, gsub, pattern = "<|>", replacement = ""))

# making all concentraions numeric
metadata <- metadata %>% mutate_at(c("DOC_mg_C_L", "STDEV_DOC", "STER_DOC",
                               "TN_mg_N_per_L", "STDEV_TN", "STER_TN",
                               "TDN_mg_N_per_L", "STDEV_TDN", "STER_TDN",
                               "NO3_mg_per_L_as_Nitrate", "STDEV_NO3", "STER_NO3",
                               "NH4_mg_per_L_as_NH4", "STER_NH4"), as.numeric)

# Filter only post-burn/reference # study_ID 22 has some pre-burn and post-burn means that I want to ignore right now 
metadata <- metadata %>% 
  filter(Treatment == "Burn" | Treatment == "Unburn")

# Create a column that takes the time_since_fire column and mutates it into categorical buckets 
unique(metadata$Time_Since_Fire)

# BRIE advice for the below chunk #
# remove years using string remove 
# something within tidy to work with factors 
# look at the factors link in the chat 

# JSC solution to this mutate 
metadata <- metadata %>% 
  mutate(metadata, TSF = ifelse(grepl("12-13", Time_Since_Fire), ">10 years",
                              ifelse(grepl("0|0-1|0-2|1 month|1|2|3|1-3|1-2", Time_Since_Fire), "0-3 years",
                              ifelse(grepl("4|5", Time_Since_Fire), "4-5 years",
                              ifelse(grepl("6|7|8|9|10", Time_Since_Fire), "6-10 years",
                              ifelse(grepl("Pre-fire", Time_Since_Fire), "Pre-Fire",
                              ifelse(grepl("1-13 years post fire|Post-fire", Time_Since_Fire), "Post-Fire", "Other")))))))

# No study ID's should be classified as Other #
unique(metadata$TSF)
```


#### STEP 2 calculate the means for each analyte by site  ### 
```{r Analyte summary stats}

# pivoting to make the responses in one column
metadata_long <- metadata %>% 
  pivot_longer(
    cols = DOC_mg_C_L:STER_NH4,
    names_to = "response_var",
    values_to = "mean_concentration",
    values_drop_na = TRUE
  )

# calculating the mean of all the burns and all the controls by analyte for each study #
MeanConcTest <- metadata_long %>%
  group_by(Study_ID, Pair_JSC, Treatment, response_var, Koppen) %>%
  dplyr::summarize(Ne = sum(Treatment == "Burn"),
                   Nc = sum(Treatment == "Unburn"),
                   Xe = mean(mean_concentration[Treatment == "Burn"], na.rm = TRUE),
                   Xc = mean(mean_concentration[Treatment == "Unburn"], na.rm = TRUE))




# This is calculating the mean for EACH site within a study_ID # 
    # Any study_ID that doesn't have up to 10 sites will have a 0 in the respective Xen column 
analyte_table_means <- MeanConcTest %>%
  select(-Pair_JSC) %>%
  group_by(Study_ID, response_var, Koppen) %>%
  summarize(Ne = sum(Ne),
            Nc = sum(Nc),
            Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
            Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
            Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
            Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
            Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
            Xe6 = sum(Xe[Pair_JSC == "Site 6"], na.rm = TRUE),
            Xe7 = sum(Xe[Pair_JSC == "Site 7"], na.rm = TRUE),
            Xe8 = sum(Xe[Pair_JSC == "Site 8"], na.rm = TRUE),
            Xe9 = sum(Xe[Pair_JSC == "Site 9"], na.rm = TRUE),
            Xe10 = sum(Xe[Pair_JSC == "Site 10"], na.rm = TRUE),
            Xc = sum(Xc[Pair_JSC == "Control"], na.rm = TRUE)) 

# making all the cells with 0 due to no sites beyond what the study had NAs to visualize the dataframe a little better. 
analyte_table_means[analyte_table_means == 0] <- NA

# This chunk is calculating the percent_change between the sites and the control. 
# study_ID 12 is the ONLY site with multiple controls. SO I am filtering it out for now:
### BRIE advice ###
# study_ID 12 is the poo poo study with multiple controls
# pulling it out and then put it back in using add_row
# ifelse statement teaching moment- wee

analyte_table_percent_change <- analyte_table_means %>% 
  filter(Study_ID != "12") %>% 
  group_by(Study_ID, response_var, Koppen) %>%
  mutate(percent_change1 = (((Xe1-Xc)/Xc)*100),
         percent_change2 = (((Xe2-Xc)/Xc)*100),
         percent_change3 = (((Xe3-Xc)/Xc)*100),
         percent_change4 = (((Xe4-Xc)/Xc)*100),
         percent_change5 = (((Xe5-Xc)/Xc)*100),
         percent_change6 = (((Xe6-Xc)/Xc)*100),
         percent_change7 = (((Xe7-Xc)/Xc)*100),
         percent_change8 = (((Xe8-Xc)/Xc)*100),
         percent_change9 = (((Xe9-Xc)/Xc)*100),
         percent_change10 = (((Xe10-Xc)/Xc)*100))

# This is doing the same thing as analyte_table_means chunk but adding in the multiple controls for study_ID_12

brie_test <- MeanConcTest %>% 
  filter(Study_ID == "12") %>% 
  group_by(Study_ID, response_var, Koppen) %>%
  summarize(Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
            Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
            Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
            Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
            Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
            Xc123 = sum(Xc[Pair_JSC == "Control 1, 2, and 3"], na.rm = TRUE),
            Xc4 = sum(Xc[Pair_JSC == "Control 4"], na.rm = TRUE),
            Xc5 = sum(Xc[Pair_JSC == "Control 5"], na.rm = TRUE)) 

# This is doing the same as analyte_table_percent_change but for study_ID_12
# I am also adding columns to match the columns to ultimately combine analyte_table_percent_change with this below chunk that does the stats for study_ID_12
brie_test_stats <- brie_test %>% 
  group_by(Study_ID, response_var, Koppen) %>%
  mutate(percent_change1 = (((Xe1-Xc123)/Xc123)*100),
         percent_change2 = (((Xe2-Xc123)/Xc123)*100),
         percent_change3 = (((Xe3-Xc123)/Xc123)*100),
         percent_change4 = (((Xe4-Xc4)/Xc4)*100),
         percent_change5 = (((Xe5-Xc5)/Xc5)*100)) %>% 
  add_column(Ne = NA,
             Nc = NA,
             Xe6 = NA,
             Xe7 = NA,
             Xe8 = NA,
             Xe9 = NA,
             Xe10 = NA,
             Xc = NA,
             percent_change6 = NA,
             percent_change7 = NA,
             percent_change8 = NA,
             percent_change9 = NA,
             percent_change10 = NA) %>% 
  ungroup()

# Adding columns to match brie_test_stats
analyte_table_percent_change <-analyte_table_percent_change %>% 
  add_column(Xc123 = NA,
             Xc4 = NA,
             Xc5 = NA) %>% 
  ungroup()

# combining study_ID_12 back into the mix 
analyte_table_combine <- analyte_table_percent_change %>% 
  add_row(brie_test_stats)

# Adding a broader climate variable that will group the codes into climates that people actually understand #
unique(analyte_table_combine$Koppen)

analyte_table_combine <- analyte_table_combine %>% 
  mutate(analyte_table_combine, Climate = ifelse(grepl("Dfb|Dfc|Dsc", Koppen), "Cold",
                              ifelse(grepl("Cfb|Csa|Csb", Koppen), "Temperate",
                              ifelse(grepl("BSk", Koppen), "Arid",
                              ifelse(grepl("As|Af|Am", Koppen), "Tropical",
                              ifelse(grepl("ET|EF", Koppen), "Polar", "Other"))))))

# export dataframe 
write.csv(analyte_table_combine, "~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/Output_for_analysis/analyte_table_without_TSF.csv", row.names=FALSE)


# pivoting to make the responses in one column
analyte_table_long <- analyte_table_combine %>% 
  pivot_longer(
    cols = percent_change1:percent_change10,
    names_to = "Site",
    values_to = "Percent_Difference",
    values_drop_na = TRUE
  )

# filter out the only analytes that we want to include in the figure 
analyte_table_filter <- analyte_table_long %>% 
  filter(response_var == "DOC_mg_C_L"| response_var == "NO3_mg_per_L_as_Nitrate",
         Study_ID != "27",
         Percent_Difference < 3000)

# I want to pivot_longer to make all means in one column
# pivoting to make the responses in one column
analyte_table_long_2 <- analyte_table_filter %>% 
  pivot_longer(
    cols = Xe1:Xc5,
    names_to = "Stats",
    values_to = "Value",
    values_drop_na = TRUE
  )

# Calculating the standard deviation for all of the percent_differences
# calculating the mean percent_difference by climate 
climate.summary <- analyte_table_filter %>%
  group_by(Koppen, response_var, Climate) %>%
  summarise(
    sd = sd(Percent_Difference, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )

```

### STEP 3 Plotting ###
```{r plots}
# Ploting #
vn = expression(paste(""*N*O[3]^"-"))

give.n <- function(x){
  return(c(y = median(x)*1.05, label = length(x))) 
  # experiment with the multiplier to find the perfect position
}


# geom_jitter for climate # 
ggplot(analyte_table_filter, aes(Percent_Difference, Koppen, color = response_var),
              position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), data = climate.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  xlim(-100, 700) +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  stat_summary(fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75)) +
  theme_classic()

ggsave("site.difference.geom_pointrange.climate.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/02_Wenas_lit_figure_no_TSF"),
       width = 10, height = 8, units = "in")


# attempt to do shading in the background # 
ggplot(analyte_table_filter, aes(Percent_Difference, Koppen),
              position = position_dodge(width = -0.5)) +
  geom_jitter(aes(color = response_var),
              position = position_jitter(0.1), alpha = 0.4) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = Koppen, ymax = dplyr::lead(Koppen), fill = Climate), 
                      alpha = 0.3,
                      linejoin = "bevel",
                      data = climate.summary) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), data = climate.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  xlim(-100, 700) +
  scale_fill_manual(values = c("#D55E00", "#56B4E9", "#009E73")) +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  
theme_classic()



ggsave("site.difference.geom_pointrange.climate.shading.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/02_Wenas_lit_figure_no_TSF"),
       width = 10, height = 8, units = "in")


# geom_jitter for climate facet # 
ggplot(analyte_table_filter, aes(Percent_Difference, Koppen, color = response_var),
              position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), data = climate.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  facet_grid(~Climate ~ .) +
  xlim(-100, 700) +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic()

ggsave("site.difference.geom_pointrange.climate.facet.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/02_Wenas_lit_figure_no_TSF"),
       width = 10, height = 8, units = "in")


```