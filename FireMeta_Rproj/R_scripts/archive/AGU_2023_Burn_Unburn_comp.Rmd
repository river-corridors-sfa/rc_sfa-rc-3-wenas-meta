---
title: "AGU_2023_Burn_Unburn_comp"
output: html_document
date: "2023-12-01"
editor_options: 
  chunk_output_type: console
---

The purpose of this script is to read in the studies from the final meta data list and to normalize daily stream concentrations by time and plot burn vs. unburned concentrations for a figure for my presentation

# Status: in progress

# ==============================================================================
# Author: Jake Cavaiani 
# 18 October 2023
# ==============================================================================

## Temporal Normalization 
```{r Jake/Mac Load Packages and}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment


library(tidyverse)
library(here)
library(forecastML)
library(zoo)
library(hrbrthemes)
library(viridis)
library(car)

```

```{r data prepper}
studies_file_list <- list.files(path = "~/GitHub/rc_sfa-rc-3-wenas-meta/FireMeta_Rproj/inputs/Studies/meta_final/", 
                                  recursive=F, 
                                  pattern=".csv", 
                                  full.names=TRUE)

storm_list_beta<-do.call("list", lapply(studies_file_list, 
                                        read.csv, 
                                        stringsAsFactors=FALSE, 
                                        header=T))

meta_df <-do.call("rbind", lapply(studies_file_list, 
                                     read.csv, 
                                     check.names = FALSE,
                                     stringsAsFactors=FALSE, 
                                     header=T, blank.lines.skip = TRUE, fill=TRUE)) 


```


```{r data prep}
options(max.print = 40)
# Filtering by only the control vs.impact studies because the pre_post are going to go through a different calculation 
# Also filtering out the studies where I don't have exact sampling days  (Caldwell, Stephan, Writer)
# Greater than 5 years, those are done in separate scripts 
control_impact <- meta_df %>% 
  filter(`Design (Control/Burn; Pre/Post)` == "Control_Reference_vs_Impact",
         Study_ID != "Caldwell et al. 2020",
         Study_ID != "Stephan et al. 2015",
         Study_ID != "Writer & Murphy, 2012", 
         Mean_Median_or_IndividualSample == "Individual",
         as.numeric(Time_Since_Fire) < 6)

# separate out the time columns 
time_format <- control_impact %>% 
  select(Study_ID, Sampling_Date) 

# Make them all the same format and then merge back together in one column
time_format <- time_format %>% 
  mutate(DateTime = mdy(Sampling_Date),
         DateTime2 = mdy_hm(Sampling_Date), 
         DateTime2 = as.Date(DateTime2)) %>% 
  select(-Sampling_Date) %>% 
  mutate(Sampling_Date = coalesce(DateTime, DateTime2),
         Sampling_Date = as.character(Sampling_Date)) %>% 
  select(-DateTime, -DateTime2) 

# merge this dataframe with the metadata df to make sure all the dates are the same format and there aren't any NAs
control_impact <- control_impact %>% 
  mutate(Sampling_Date = time_format$Sampling_Date)


# changing the structure of the concentrations
control_impact <- control_impact %>% 
  mutate(DOC = as.numeric(DOC),
         NO3 = as.numeric(NO3), 
         Sampling_Date = ymd(Sampling_Date))

# Changing the units to make sure everything is consistent in mg_N_L or mg_C_L
control_impact_units <- control_impact %>% 
  mutate(Area_watershed_km = case_when(Area_unit == 'ha' ~ Area_watershed * .01,
                                       Area_unit == 'km' ~ print(Area_watershed)),
         
         DOC_mg_C_L = case_when(DOC_unit == 'mg_C_L' ~ print(DOC),
                                DOC_unit == 'mg_L' ~ print(DOC),
                                DOC_unit == 'um' ~ DOC * 0.01201),
         
         NO3_mg_N_L = case_when(NO3_unit == 'um' ~ NO3 * 0.014007000,
                                NO3_unit == 'umol_L' ~ NO3 * 0.014007000,
                                NO3_unit == 'umol_NO2_NO3_L' ~ NO3 * 0.014007000,
                                NO3_unit == 'mg_N_L' ~ print(NO3),
                                NO3_unit == 'ug_N_L' ~ NO3 * .001, 
                                NO3_unit == 'mg_L' ~ NO3 * 0.225904780),
         
         DOC_uM_C = case_when(DOC_unit == 'um' ~ print(DOC),
                              DOC_unit == 'mg_C_L' ~ DOC * 83.2639467,
                              DOC_unit == 'mg_L' ~ DOC * 83.2639467),

         NO3_uM_N = case_when(NO3_unit == 'um' ~ print(NO3),
                              NO3_unit == 'umol_L' ~ print(NO3),
                              NO3_unit == 'umol_NO2_NO3_L' ~ print(NO3),
                              NO3_unit == 'mg_L' ~ NO3 * 16.127729,
                              NO3_unit == 'mg_N_L' ~ NO3 * 3.64145101,
                              NO3_unit == 'ug_N_L' ~ NO3 * 0.22594948))




# Creating a site characteristics data frame that I will use to merge later to add in the proper data 
site_data <- control_impact_units %>% 
  select(Study_ID, Pair, Latitude, Longitude, Area_watershed_km, Climate, Burn_Unburn)

site_data_unique <- site_data %>% 
  group_by(Study_ID, Pair, Area_watershed_km) %>% 
  distinct(Area_watershed_km, .keep_all = TRUE)

```


```{r - all the studies}
# Okay lets do this for all the studies # 
# filling in daily time series and interpolating by study and site
control_impact_fill <-  control_impact_units %>% 
  select("Study_ID", "Latitude", "Longitude", "Area_watershed_km", "Pair", "Climate", "Site", "Burn_Unburn", "Sampling_Date", "DOC_uM_C", "NO3_uM_N") %>%
  group_by(Study_ID, Site) %>%
  complete(Sampling_Date = seq(min(Sampling_Date), max(Sampling_Date), by = "1 day")) %>% 
  fill(Study_ID:Burn_Unburn) %>%
  fill(Study_ID, Site) %>%
  ungroup() %>%
  group_by(Site) %>%
  mutate(NO3_Interp = na.approx(NO3_uM_N, na.rm = FALSE),
         DOC_Interp = na.approx(DOC_uM_C, na.rm = FALSE)) %>%
  fill(Study_ID:Burn_Unburn)


control_impact_fill <- control_impact_fill %>% 
  mutate(year = year(Sampling_Date),
         month = month(Sampling_Date),
         day = day(Sampling_Date))
  

```


```{r pivot long and create TempNorm}
# This is code from my other script. I am going to try this way to see if this is what we want to get to 
# pivoting to make the responses in one column
metadata_long <- control_impact_fill %>%
  pivot_longer(
    cols = NO3_Interp:DOC_Interp,
    names_to = "response_var",
    values_to = "concentration",
    values_drop_na = TRUE
  )


# aggregate by year 
yearly_mean_site <-  metadata_long %>%
  group_by(Study_ID, response_var, Pair, year) %>% 
  summarize(meanConc = mean(concentration)) %>% 
  left_join(site_data) %>% 
  group_by(year) %>% 
  distinct(meanConc, .keep_all = TRUE) %>% 
  mutate(TempNorm = meanConc / Area_watershed_km) 

yearly_mean_site$TempNorm <- format(yearly_mean_site$TempNorm, scientific = F)

yearly_mean_site <-  yearly_mean_site %>% 
  mutate(TempNorm = as.numeric(TempNorm)) 

```

# Add in corrected Crandall and papers that are greater than 5 years to this list 
```{r}
# combine the conc. fill of Crandall, Abbott, and Rhea with the rest of it 

crandall_conc_fill <- read_csv(here("Output_for_analysis", "crandall_conc_fill.csv")) %>% 
  select(-...1)

abbott_conc_fill <- read_csv(here("Output_for_analysis", "Abbott_conc_fill.csv")) %>% 
  select(-...1)

rhea_conc_fill <- read_csv(here("Output_for_analysis", "Rhea_conc_fill.csv")) %>% 
  select(-...1)


yearly_mean_site <- rbind(yearly_mean_site, crandall_conc_fill, abbott_conc_fill, rhea_conc_fill)

```


```{r Calculate CV}
metadata_cv <- yearly_mean_site %>% 
  group_by(Study_ID, response_var, Burn_Unburn) %>% 
  summarise(meanconc = mean(TempNorm, na.rm = TRUE),
            sdconc = sd(TempNorm, na.rm = TRUE),
            CVconc = sdconc/meanconc) # generating CVs

doc_cv <- metadata_cv %>% 
  filter(response_var == "DOC_Interp")

# DOC 
doc_yearly <- yearly_mean_site %>% 
  filter(response_var == "DOC_Interp")

# doc_cv <- doc_yearly %>% 
#   group_by(Burn_Unburn) %>% 
#   summarise(meanconc = mean(TempNorm, na.rm = TRUE),
#             sdConc = sd(TempNorm, na.rm = TRUE),
#             CVconc = sdConc/meanconc)

# conduct Levene's Test for equality of variances
leveneTest(TempNorm ~ Burn_Unburn, data = doc_yearly)

# p-value: 0.42 - not significant 


# NO3 
no3_yearly <- yearly_mean_site %>% 
  filter(response_var == "NO3_Interp")

no3_cv <- metadata_cv %>% 
  filter(response_var == "NO3_Interp")


# no3_cv <- no3_yearly %>% 
#   group_by(Burn_Unburn) %>% 
#   summarise(meanconc = mean(TempNorm, na.rm = TRUE),
#             sdConc = sd(TempNorm, na.rm = TRUE),
#             CVconc = sdConc/meanconc)

# conduct Levene's Test for equality of variances
leveneTest(TempNorm ~ Burn_Unburn, data = no3_yearly)

# p-value: 0.38 - not significant 

```

### PLOT Burn vs. Unburn ###

```{r}
# DOC 
# simple box plot 
ggplot(doc_yearly, aes(Burn_Unburn, TempNorm, fill = Burn_Unburn)) +
  geom_boxplot() +
  theme_bw()
  
# Boxplot with density plot   
ggplot(doc_yearly, aes(x = Burn_Unburn, y = TempNorm, fill = Burn_Unburn)) +
  scale_fill_manual(values = c("darkred", "green")) +
  labs(x =  " ", y = expression(paste("Yield (mg  ", DOC ," ", L^-1, km^-2, ")"))) +
  ggdist::stat_halfeye(adjust = 0.5, 
                       justification = -.2,
                       .width = 0,
                       point_colour = NA) +
  geom_boxplot(width = .25,
                 outlier.colour = NA,
                 alpha = 0.5) +
  ylim(0,100) +
  ggtitle("DOC Yield") +
  theme_bw() +
  theme(legend.position = "none")

ggsave("DOC_yield.pdf",
       path = here("initial_plots"),
       width = 6, height = 8,  units = "in")

# histogram with burn/unburned on top of each other
doc_yearly %>% 
ggplot(aes(x = TempNorm, fill = Burn_Unburn)) +
    geom_histogram(binwidth=3, color="#e9ecef", alpha=0.9) +
    scale_fill_manual(values = c("darkred", "#69b3a2")) +
    labs(x = expression(paste("Yield (mg  ", DOC ," ", L^-1, km^-2, ")"))) +
    ggtitle("DOC Yield") +
    theme_bw() +
    theme(plot.title = element_text(size=15),
          axis.text.x = element_text(size = 25),
          axis.title.x = element_text(size = 25),
          axis.text.y = element_text(size = 25),
          axis.title.y = element_text(size = 25))

ggsave("DOC_histogram.pdf",
       path = here("initial_plots", "AGU"),
       width = 6, height = 8,  units = "in")

# Box plot with CV
ggplot(doc_cv, aes(x = Burn_Unburn, y = CVconc, fill = Burn_Unburn)) +
  scale_fill_manual(values = c("darkred", "#69b3a2")) +
  labs(y = "CV", x = "") +
  ggdist::stat_halfeye(adjust = 0.5, 
                       justification = -.2,
                       .width = 0,
                       point_colour = NA) +
  geom_boxplot(width = .25,
                 outlier.colour = NA,
                 alpha = 0.5) +
  ggtitle("Coefficient of Variation for DOC") +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 25),
        axis.text.y = element_text(size = 25),
        axis.title.y = element_text(size = 25))
        

ggsave("DOC_CV.pdf",
       path = here("initial_plots", "AGU"),
       width = 6, height = 8,  units = "in")


# NO3


vn = expression(paste("Yield (mg " *N*O[3]^"-",  L^-1, km^-2, ")"))

# Boxplot with density plot   
ggplot(no3_yearly, aes(x = Burn_Unburn, y = TempNorm, fill = Burn_Unburn)) +
  scale_fill_manual(values = c("darkred", "green")) +
  ggdist::stat_halfeye(adjust = 0.5, 
                       justification = -.2,
                       .width = 0,
                       point_colour = NA) +
  geom_boxplot(width = .25,
                 outlier.colour = NA,
                 alpha = 0.5) +
  ylab(vn) +
  xlab("") +
  ggtitle("Nitrate Yield") +
  theme_bw() +
  theme(legend.position = "none")

ggsave("NO3_yield.pdf",
       path = here("initial_plots"),
       width = 6, height = 8,  units = "in")



# histogram with burn/unburned on top of each other
no3_yearly %>% 
ggplot(aes(x = TempNorm, fill = Burn_Unburn)) +
    geom_histogram(binwidth=3, color="#e9ecef", alpha=0.9) +
    scale_fill_manual(values = c("darkred", "#69b3a2")) +
    xlab(vn) +
    ggtitle("Nitrate Yield") +
    theme_bw() +
    theme(plot.title = element_text(size=15),
          axis.text.x = element_text(size = 25),
          axis.title.x = element_text(size = 25),
          axis.text.y = element_text(size = 25),
          axis.title.y = element_text(size = 25))

ggsave("NO3_histogram.pdf",
       path = here("initial_plots", "AGU"),
       width = 6, height = 8,  units = "in")

# Box plot with CV
ggplot(no3_cv, aes(x = Burn_Unburn, y = CVconc, fill = Burn_Unburn)) +
  scale_fill_manual(values = c("darkred", "#69b3a2")) +
  labs(y = "CV", x = "") +
  ggdist::stat_halfeye(adjust = 0.5, 
                       justification = -.2,
                       .width = 0,
                       point_colour = NA) +
  geom_boxplot(width = .25,
                 outlier.colour = NA,
                 alpha = 0.5) +
  ggtitle("Coefficient of Variation for Nitrate") +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 25),
        axis.text.y = element_text(size = 25),
        axis.title.y = element_text(size = 25))

ggsave("NO3_CV.pdf",
       path = here("initial_plots", "AGU"),
       width = 6, height = 8,  units = "in")




```
