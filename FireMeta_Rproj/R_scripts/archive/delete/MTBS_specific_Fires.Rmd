---
title: "MTBS_specific_Fires"
output: html_document
date: "2023-11-01"
editor_options: 
  chunk_output_type: console
---

This is adapted Kristian code to get burn severity from specific fires 

```{r}
# Set up packages.
require(pacman)
p_load(readr,
       dplyr,
       tibble,
       exactextractr,
       ggplot2,
       viridis,
       rasterVis,
       tidyr,
       raster, 
       ggthemes, 
       ggnewscale, 
       ggspatial,
       nhdplusTools, 
       elevatr, 
       sf,
       units,
       here) 



# Test #
shapefile <- st_read("~/GitHub/rc_sfa-rc-3-wenas-meta/FireMeta_Rproj/inputs/KN_code/wa4685412079920200831_20200830_20200909_burn_bndy.shp")

gaviota <- st_read(here("gis_data", "Fire_Perimeters", "Gaviota", "ca3448712019620040605_20040425_20050412_burn_bndy.shp"))

ggplot() +
  geom_sf(data = gaviota, aes(fill = "red"))

watershed_bnd <-  st_read(here("inputs", "KN_code", "YRB.shp"))

st_drivers()

gdal.SetConfigOption('SHAPE_RESTORE_SHX', 'YES')
####

# Output Path 
output_path <- "~/GitHub/rc_sfa-rc-3-wenas-meta/FireMeta_Rproj/initial_plots/Maps/"

# Evans Canyon

specific_fire <- "~/GitHub/rc_sfa-rc-3-wenas-meta/FireMeta_Rproj/inputs/KN_code/wa4685412079920200831_20200830_20200909_burn_bndy.shp"

burnSeverity <- "~/GitHub/rc_sfa-rc-3-wenas-meta/FireMeta_Rproj/inputs/KN_code/WA_Burn_Severity/mtbs_WA_2020.tif"
watershed_bnd <-"~/GitHub/rc_sfa-rc-3-wenas-meta/FireMeta_Rproj/inputs/KN_code/YRB.shp"

# Schneider Springs


specificFires <- function(fire = specific_fire, 
                          BS = burnSeverity, 
                          watersheds = watershed_bnd,
                          fire_name = "Evans Canyon",
                          map_output = output_path,
                          generate_maps = TRUE){
  # Read in shapefiles
  st_read(fire, quiet = TRUE) -> single_fire
  st_read(watersheds, quiet = TRUE) %>% 
    st_transform(crs=crs(single_fire)) -> fire_wtrshd  
  raster(BS) %>% 
    projectRaster(crs=crs(single_fire)) %>% 
    crop(single_fire) -> raster_bs
  # Read in raster and convert to same projection. Extract burn severity values.
  watershed_list <- list()
  w_num <- 1:nrow(fire_wtrshd)
  #w_num <-1
  for(i in w_num){
  message(paste0("Running number",i))
  fire_wtrshd[i,] -> single_wtrshd
  st_area(single_wtrshd) %>% 
    drop_units() %>% 
    as.double() -> watershed_area
  
  suppressWarnings(exact_extract(raster_bs,single_wtrshd)) %>% 
    as.data.frame()-> extracted_values
  
  if(all(is.na(extracted_values$value)) == TRUE){
    burn_final<-data.frame(comid = as.character(single_wtrshd$comid),
                           site = as.character(single_wtrshd$site),
                           Name = as.character(fire_name),
                           Unburned_m2 = watershed_area,
                           Unburned_Percent = as.double(0),
                           Low_Burn_m2 = as.double(0),
                           Low_Burn_Percent = as.double(0),
                           Moderate_Burn_m2 = as.double(0),
                           Moderate_Burn_Percent = as.double(0),
                           High_Burn_m2 = as.double(0),
                           High_Burn_Percent = as.double(0),
                           Total_Burned_m2 = as.double(0), 
                           Percent_Burned = as.double(0),
                           Watershed_Area = watershed_area)
    i->n
    burn_final -> watershed_list[[n]]
    next
  }
  
  if(nrow(extracted_values) < 1){
    burn_final<-data.frame(comid = as.character(single_wtrshd$comid),
                           site = as.character(single_wtrshd$site),
                           Name = as.character(fire_name),
                           Unburned_m2 = watershed_area,
                           Unburned_Percent = as.double(0),
                           Low_Burn_m2 = as.double(0),
                           Low_Burn_Percent = as.double(0),
                           Moderate_Burn_m2 = as.double(0),
                           Moderate_Burn_Percent = as.double(0),
                           High_Burn_m2 = as.double(0),
                           High_Burn_Percent = as.double(0),
                           Total_Burned_m2 = as.double(0), 
                           Percent_Burned = as.double(0),
                           Watershed_Area = watershed_area)
    i->n
    burn_final -> watershed_list[[n]]
    next
  }
  
  if(nrow(extracted_values)>0){
  st_intersection(single_wtrshd,single_fire) -> intersect
    
  suppressWarnings(exact_extract(raster_bs,intersect)) %>% 
   as.data.frame()-> extracted_values
      
  extracted_values$area_m2 <- 30*30
  extracted_values$coverage_fraction * extracted_values$area_m2 -> extracted_values$adj_area_m2
  
  if_else(extracted_values$value == 1.5, 2, extracted_values$value) -> extracted_values$value
  if_else(extracted_values$value == 2.5, 3, extracted_values$value) -> extracted_values$value
  if_else(is.na(extracted_values$value), 1, extracted_values$value) -> extracted_values$value
  if_else(extracted_values$value == 5, 2, extracted_values$value) -> extracted_values$value
  
  extracted_values %>% 
      group_by(value) %>% 
      summarise(area = sum(adj_area_m2)) -> aggregate2
  
  extra_var <- data.frame(value = c(1,2,3,4),
                          area = c(0,0,0,0))
  bind_rows(aggregate2, extra_var) -> binded
  binded %>% 
    group_by(value) %>% 
    summarise(area = sum(area)) -> aggregate
  
  aggregate$Percent_of_Watershed <- (aggregate$area/watershed_area) * 100
  aggregate$Percent_of_Watershed<-format(round(aggregate$Percent_of_Watershed,3),nsmall=3)
  aggregate$Percent_of_Watershed <- as.double(aggregate$Percent_of_Watershed)
  aggregate$area <- as.double(aggregate$area)
  aggregate[,c(1,2)] -> w_area
  aggregate[,c(1,3)] -> w_percent
  
  w_area %>% 
    rownames_to_column() %>% gather(variable, value, -rowname) %>%
    spread(rowname, value) %>% .[-2,-1]-> area_Burn
  c("Unburned_m2","Low_Burn_m2","Moderate_Burn_m2","High_Burn_m2") -> names(area_Burn)
  w_percent %>% 
    rownames_to_column() %>% gather(variable, value, -rowname) %>%
    spread(rowname, value) %>% .[-2,-1]-> percent_Burn
  c("Unburned_Percent","Low_Burn_Percent","Moderate_Burn_Percent","High_Burn_Percent") -> names(percent_Burn)
  cbind(area_Burn,percent_Burn) -> Burn
  # Add column names to reflect burn severity. Add fire name.
  single_wtrshd$comid -> Burn$comid
  single_wtrshd$site -> Burn$site
  fire_name -> Burn$Name
  Burn %>% dplyr::select(c(9,10,11,1,5,2,6,3,7,4,8)) -> burn_final
  
  st_intersection(single_wtrshd,single_fire) -> intersect
  st_area(intersect) -> Total_Area_Burned_m2
  st_area(intersect)/st_area(single_wtrshd) -> Percent_Burned
  burn_final$`Total_Burned_m2` <- Total_Area_Burned_m2 %>% drop_units()
  burn_final$`Percent_Burned` <- Percent_Burned %>% drop_units()
  burn_final$Watershed_Area <- watershed_area
  burn_final[,c(1,2,3)] <- as.character(burn_final[,c(1,2,3)])
  burn_final[,c(4:13)] <- as.double(burn_final[,c(4:13)])
  i->n
  burn_final -> watershed_list[[n]]
  
  if(generate_maps == TRUE){
        single_fire %>% st_transform(crs=4326) -> proj
        st_centroid(proj) %>% .[1,2] %>%  st_coordinates() -> coords
        
        bs_spdf <- as(raster_bs, "SpatialPixelsDataFrame")
        bs_df <- as.data.frame(bs_spdf)
        colnames(bs_df) <- c("value", "x", "y")
        
        flowlines <- get_nhdplus(AOI = single_wtrshd)
        
        elevation_raw <- get_elev_raster(single_wtrshd, z = 10)
        elevation_crop <- mask(elevation_raw, single_wtrshd)
        
        elev_spdf <- as(elevation_crop, "SpatialPixelsDataFrame")
        elev_df <- as.data.frame(elev_spdf) 
        colnames(elev_df) <- c("value", "x", "y")
        single_wtrshd$site -> site_name
        ggplot() +
          geom_sf(data = single_wtrshd) +
          geom_raster(data = elev_df,aes(x = x,y = y, fill = value), show.legend = F, alpha = 0.8) +
          scale_fill_gradientn(colors = c("#EFF7EA", "#ADD7A1", "#5FA965", "#245836", "#911C43")) +
          new_scale_fill() +
          geom_sf(data = flowlines, color = "blue") +
          geom_raster(data = bs_df, aes(x = x,y = y, fill = value)) +
          geom_sf(data = single_fire, fill = NA, color = "red", lwd = 0.5) +
          scale_fill_viridis(option = "F") +
          #scale_fill_manual(values = fire_colors)+
          theme_map() + 
          labs(x = "", y = "", fill = "Burn Severity Level") + 
          theme(legend.position="bottom") +
          ggspatial::annotation_scale(
            location = "bl",
            pad_x = unit(0, "in"), pad_y = unit(0, "in"),
            bar_cols = c("black", "white")) +
          ggspatial::annotation_north_arrow(
            location = "bl", which_north = "true",
            pad_x = unit(2.6, "in"), pad_y = unit(0, "in"),
            style = ggspatial::north_arrow_nautical(
              fill = c("black", "white"),
              line_col = "grey20"))
        
        ggsave(paste0(map_output,fire_name,"_BS_",site_name,".jpeg"),device = "jpeg",  width = 11, height = 8)
        }
    }
  }
  bind_rows(watershed_list) -> full_df
  return(full_df)
}






```