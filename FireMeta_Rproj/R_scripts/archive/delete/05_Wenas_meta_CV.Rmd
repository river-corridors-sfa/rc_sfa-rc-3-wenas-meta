---
title: "05_Wenas_meta_CV"
output: html_document
date: "2023-08-24"
editor_options: 
  chunk_output_type: console
---

The purpose of this script is to assess the coefficient of variation for both DOC and nitrate concentrations in burned and the reference sites. 

I want to compare these two and if they are significantly different from each other (I suspect the burned sites will be more variable) than I could say tie to some type of resilience/tipping point indicator themes. 

Workflow:
Step 1) Load in cleaned meta data sheet from github repo located in "rc_sfa-rc-3-wenas-modeling->Lit_Review_Fig->Output_for_analysis->metadata_clean.csv"

Step 2) Filter DOC and Nitrate

Step 3) using tidy, generate CVs for each study_ID (CV = standard_deviation/mean)

Step 4) perform stats to see if they are significantly different (anovas?)

## Load packages and set working directory
```{r Jake/Mac}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment

library(ggplot2)
library(googlesheets4)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(lme4)
library(lmerTest)
```



```{r read in tibble and filter out just to have DOC and Nitrate}
metadata_clean <- read_csv("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/Output_for_analysis/metadata_clean.csv")

metadata_doc_no3 <- metadata_clean %>% 
  select(Study_ID, Pair_JSC, Koppen, Treatment, Time_Since_Fire_JSC,
         DOC_mg_C_L, NO3_mg_per_L_as_Nitrate) # selecting only the variables that I want 

# pivoting to make the responses in one column
metadata_long <- metadata_doc_no3 %>% 
  pivot_longer(
    cols = DOC_mg_C_L:NO3_mg_per_L_as_Nitrate,
    names_to = "response_var",
    values_to = "mean_concentration",
    values_drop_na = TRUE
  )

metadata_cv <- metadata_long %>% 
  group_by(Study_ID, response_var, Koppen, Treatment) %>% 
  summarise(meanConc = mean(mean_concentration, na.rm = TRUE),
            sdConc = sd(mean_concentration, na.rm = TRUE),
            CVconc = sdConc/meanConc) # generating CVs

# plot # 
vn = expression(paste(""*N*O[3]^"-"))

ggplot(metadata_cv, aes(x = Treatment, y = CVconc, fill = response_var)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#FF7F00", "#3288BD"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  xlab("") +
  ylab("CV Stream Concentration") +
  theme_classic() +
  theme(legend.position = c(0.8, 0.85),
        axis.text.x = element_text(size = 30),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 40),
        axis.title.y = element_text(size = 25),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 30))
  

# generating some summary stats
metadata_cv_summary <- metadata_cv %>% 
  group_by(response_var, Treatment) %>% 
  summarise(meanCV = median(CVconc, na.rm = TRUE))

```
# On the concentrations 
```{r anova models}
NO3 <- metadata_cv %>% 
  filter(response_var == "NO3_mg_per_L_as_Nitrate")

one.way.no3 <- aov(CVconc ~ Treatment, data = NO3)


summary(one.way.no3)
TukeyHSD(one.way.no3, which = "Treatment", na.rm = TRUE) # not significant (p-value = 0.302) 
plot(one.way.no3)


#
DOC <- metadata_cv %>% 
  filter(response_var == "DOC_mg_C_L")

one.way.doc <- aov(CVconc ~ Treatment, data = DOC)


summary(one.way.doc)
TukeyHSD(one.way.doc, which = "Treatment", na.rm = TRUE) # not significant (p-value = 0.273)



# Attempt to do an anova for both response variables without having to create separate dataframes 
df.aov <- metadata_cv %>%
    group_by(response_var) %>%
    nest() %>%
    mutate(aov = map(data, ~aov(CVconc ~ Treatment, data = .x)))
df.aov$aov
# 

```

Percent difference CV 
```{r Metadata Google Sheet Import}
#import Metadata sheet that is stored on Google Sheet 
percent_difference <- read_csv("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/Output_for_analysis/analyte_table_DOC_no3.csv")

# log transform the percentages 
percent_difference <- percent_difference %>% 
  mutate(log_pd = log(abs(Percent_Difference))) # should I be taking the absolute value of the negative percent_differences?

```

Generate CVs for percent difference by climate 
```{r}
percent_difference_cv <- percent_difference %>% 
  group_by(Study_ID, response_var, Koppen, Climate) %>% 
  summarise(meanPD = mean(Percent_Difference, na.rm = TRUE),
            sdPD = sd(Percent_Difference, na.rm = TRUE),
            CVPD = sdPD/meanPD) # generating CVs

percent_difference_cv_summary <- percent_difference_cv %>% 
  group_by(response_var, Koppen) %>% 
  summarise(sdCV = sd(CVPD, na.rm = TRUE),
            CVPD = mean(CVPD, na.rm = TRUE))

percent_difference_DOC <- percent_difference_cv %>% 
  filter(response_var == "DOC_mg_C_L")

percent_difference_NO3 <- percent_difference_cv %>% 
  filter(response_var == "NO3_mg_per_L_as_Nitrate")


# plot 
vn = expression(paste(""*N*O[3]^"-"))

ggplot(percent_difference_cv, aes(x = Koppen, y = CVPD, color = response_var)) +
  geom_point() +
  scale_color_manual(values=c("#FF7F00", "#3288BD")) +
  theme_classic()


ggplot(percent_difference_cv, aes(CVPD, Koppen, color = response_var),
              position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4, size = 3) +
  geom_pointrange(aes(xmin = CVPD - sdCV, xmax = CVPD + sdCV,
                      color = response_var),
                      position = position_dodge(width = -0.5), size = 1.5, data = percent_difference_cv_summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 30),
        axis.text.y = element_text(size = 30),
        axis.title.x = element_text(size = 40),
        axis.title.y = element_text(size = 34),
        legend.text = element_text(size = 30),
        legend.position = c(0.2, 0.85))

# this figure tells us stuff that we already know that nitrate is substantially more variable compared to DOC but is it Climate dependent and it doesn't look like it but lets put some stats to this 

# IS there more variability due to the sample size or is this real by climate?


```

# STATS 
We have already investigated that percent difference is NOT different by climate. PLUS we already know that the variability is greater for nitrate than it is for DOC. Also above in this script it shows that the variability in concentrations in reference vs. burn sites are NOT significantly different (I thought they would be and then we could get something about resilience because we would expect more heterogenous source pools or flowpaths or something which might indicate tipping points/thresholds) BUT what we don't know is: IS the coefficient of variability different by climate. If climate indicated some sort of significance for the CV then WHAT....?

```{r Anova}
one.way.doc <- aov(CVPD ~ Climate, data = percent_difference_DOC)


summary(one.way.doc)
TukeyHSD(one.way.doc, which = "Climate", na.rm = TRUE) # not significant (p-value = 0.761)


one.way.no3 <- aov(CVPD ~ Climate, data = percent_difference_NO3)


summary(one.way.no3)
TukeyHSD(one.way.no3, which = "Climate", na.rm = TRUE) # not significant (p-value = 0.666)


```
I am doing an ANOVA test here for each analyte. An Anova is looking at if the means of the CV within each climate are different from each other and according to the p-value it doesn't appear that they significantly differ from each other for either DOC or nitrate which looks like that checks out with the eye test looking at the plot that was generated before. So this means that not only does climate NOT influence percent difference, it doesn't influence the variability either. SO basically climate is doing bupkis. 

```{r DOC random effects }
mDOC_climate <- lmer(CVPD ~ Climate + (1|Study_ID), data = percent_difference_DOC)
summary(mDOC_climate) 

plot(mDOC_climate)
qqnorm(resid(mDOC_climate))

anova(mDOC_climate) # f-value = 0.7755



```

```{r check for normality}
#Visualize data
ggboxplot(percent_difference_DOC$CVPD, 
          ylab = "Percent Difference (%)", xlab = FALSE,
          ggtheme = theme_minimal())


#perform shapiro-wilk test
shapiro.test(percent_difference_DOC$CVPD)

# checking to see if the data is normal 
ggqqplot(percent_difference_DOC$CVPD, ylab = "Percent Difference",
         ggtheme = theme_minimal())

# p-value is greater than 0.05 which indicates that the data is normally distributed
```

















