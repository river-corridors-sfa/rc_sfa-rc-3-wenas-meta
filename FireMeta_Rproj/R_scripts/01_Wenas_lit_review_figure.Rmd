---
title: "01_Wenas_percent_difference"
output: html_document
date: "2023-05-02"
editor_options: 
  chunk_output_type: console
---
The purpose of this script is generate an output dataframe that is similar to Table 1 in Dove & Hart, 2017 (https://link.springer.com/article/10.4996/fireecology.130237746) that includes: 
Study_ID
Years since fire (TSF)
Climate 
control replicates (Nc)
control mean (Xc)
experimental replicates (Ne)
experimental mean (Xe) 
the natural log of the response ratio (ln[R])
Percent change (percent_change)
Percent change standard deviation (percent_changeSD)
effect size standard deviation (EsSD)
Difference (Diff)
AND 
Difference standard deviation (DiffSD) 
FOR EACH STUDY_ID

We also want to create a figure showing the variability of percent change between sites that have been burned compared to their reference site that is listed in the study_ID grouped put by TSF 

Workflow:
Step 1) Load in meta data sheet from googledrive located in "Fire numerical modeling Paper->Background Figure_MEBandVGC->Wenas_modeling_Papers_use_for_Fig"

Step 2) Clean spreadsheet to filter only data that is needed 

Step 3) Group by study_ID and obtain values listed above

Step 4) Save output file as: in "enter_directory filepath"




## Load packages and set working directory
```{r Jake/Mac}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment

library(ggplot2)
library(googlesheets4)
library(tidyverse)
library(lubridate)
library(ggpubr)
```


### STEP 1 load in the data and filter out what columns we want ### 
```{r Metadata Google Sheet Import}
#import Metadata sheet that is stored on Google Sheet 
metadata <- read_sheet("https://docs.google.com/spreadsheets/d/1S1-Aheu-BJiIybye95YQzRi_9e2kS-udcsKcsC7H8dk/edit#gid=0",col_types ='c')

#you may need OAuth access. Press 1 to grant access

# select the columns that I want 
metadata <- metadata %>% select("Study_ID", "Pair_JSC", "Climate_JSC_from_climatecharts.net", 
                       "Burn or Unburn", "Time_Since_Fire", "Time_Since_Fire_JSC",
                 "DOC_mg_C_L", "STDEV_DOC", "STER_DOC",
                 "TN_mg_N_per_L", "STDEV_TN", "STER_TN",
                 "TDN_mg_N_per_L", "STDEV_TDN", "STER_TDN",
                 "NO3_mg_per_L_as_Nitrate", "STDEV_NO3", "STER_NO3",
                 "NH4_mg_per_L_as_NH4", "STER_NH4")

# rename some of the columns 
metadata <- metadata %>% 
    rename("Treatment" = "Burn or Unburn",
           "Koppen" = "Climate_JSC_from_climatecharts.net") 


# substituting all greater than or less than characters out 
# metadata <- metadata %>% 
#   mutate_all(str_remove(.,"<"))

metadata <- as.data.frame(sapply(metadata, gsub, pattern = "<|>", replacement = ""))

# making all concentraions numeric
metadata <- metadata %>% mutate_at(c("DOC_mg_C_L", "STDEV_DOC", "STER_DOC",
                               "TN_mg_N_per_L", "STDEV_TN", "STER_TN",
                               "TDN_mg_N_per_L", "STDEV_TDN", "STER_TDN",
                               "NO3_mg_per_L_as_Nitrate", "STDEV_NO3", "STER_NO3",
                               "NH4_mg_per_L_as_NH4", "STER_NH4"), as.numeric)

# Filter only post-burn/reference # study_ID 22 has some pre-burn and post-burn means that I want to ignore right now 
metadata <- metadata %>% 
  filter(Treatment == "Burn" | Treatment == "Unburn")

# Create a column that takes the time_since_fire column and mutates it into categorical buckets 
unique(metadata$Time_Since_Fire)

# BRIE advice for the below chunk #
# remove years using string remove 
# something within tidy to work with factors 
# look at the factors link in the chat 

# JSC solution to this mutate 
metadata <- metadata %>% 
  mutate(metadata, TSF = ifelse(grepl("12-13|13", Time_Since_Fire), ">10 years",
                              ifelse(grepl("6|7|8|9|10", Time_Since_Fire), "6-10 years",
                              ifelse(grepl("0|0-1|1", Time_Since_Fire), "0-1 years",
                              ifelse(grepl("2|3", Time_Since_Fire), "2-3 years",       
                              ifelse(grepl("4|5", Time_Since_Fire), "4-5 years",
                              ifelse(grepl("Pre-fire", Time_Since_Fire), "Pre-Fire",
                              ifelse(grepl("1-13 years post fire|Post-fire", Time_Since_Fire), "Post-Fire", "Other"))))))))

# No study ID's should be classified as Other #
unique(metadata$TSF)

# comparing to see if this above script actually worked 
a <- metadata$Time_Since_Fire
b <- metadata$TSF

c <- cbind(a,b)

write.csv(metadata, "~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/Output_for_analysis/metadata_clean.csv", row.names=FALSE)
```


#### STEP 2 calculate the means for each analyte by site  ### 
```{r Analyte summary stats}

# pivoting to make the responses in one column
metadata_long <- metadata %>% 
  pivot_longer(
    cols = DOC_mg_C_L:STER_NH4,
    names_to = "response_var",
    values_to = "mean_concentration",
    values_drop_na = TRUE
  )

# calculating the mean of all the burns and all the controls by analyte for each study #
MeanConcTest <- metadata_long %>%
  group_by(Study_ID, Pair_JSC, Treatment, response_var, Koppen, TSF) %>%
  dplyr::summarize(Ne = sum(Treatment == "Burn"),
                   Nc = sum(Treatment == "Unburn"),
                   Xe = mean(mean_concentration[Treatment == "Burn"], na.rm = TRUE),
                   Xc = mean(mean_concentration[Treatment == "Unburn"], na.rm = TRUE))




# This is calculating the mean for EACH site within a study_ID # 
    # Any study_ID that doesn't have up to 10 sites will have a 0 in the respective Xen column 
analyte_table_means <- MeanConcTest %>%
  select(-Pair_JSC) %>%
  group_by(Study_ID, response_var, Koppen, TSF) %>%
  summarize(Ne = sum(Ne),
            Nc = sum(Nc),
            Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
            Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
            Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
            Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
            Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
            Xe6 = sum(Xe[Pair_JSC == "Site 6"], na.rm = TRUE),
            Xe7 = sum(Xe[Pair_JSC == "Site 7"], na.rm = TRUE),
            Xe8 = sum(Xe[Pair_JSC == "Site 8"], na.rm = TRUE),
            Xe9 = sum(Xe[Pair_JSC == "Site 9"], na.rm = TRUE),
            Xe10 = sum(Xe[Pair_JSC == "Site 10"], na.rm = TRUE),
            Xc = sum(Xc[Pair_JSC == "Control"], na.rm = TRUE)) 

# making all the cells with 0 due to no sites beyond what the study had NAs to visualize the dataframe a little better. 
analyte_table_means[analyte_table_means == 0] <- NA

# This chunk is calculating the percent_change between the sites and the control. 
# study_ID 12 is the ONLY site with multiple controls. SO I am filtering it out for now:
### BRIE advice ###
# study_ID 12 is the poo poo study with multiple controls
# pulling it out and then put it back in using add_row
# ifelse statement teaching moment- wee

analyte_table_percent_change <- analyte_table_means %>% 
  filter(Study_ID != "12", Study_ID != "9") %>% 
  group_by(Study_ID, response_var, Koppen, TSF) %>%
  mutate(percent_change1 = (((Xe1-Xc)/Xc)*100),
         percent_change2 = (((Xe2-Xc)/Xc)*100),
         percent_change3 = (((Xe3-Xc)/Xc)*100),
         percent_change4 = (((Xe4-Xc)/Xc)*100),
         percent_change5 = (((Xe5-Xc)/Xc)*100),
         percent_change6 = (((Xe6-Xc)/Xc)*100),
         percent_change7 = (((Xe7-Xc)/Xc)*100),
         percent_change8 = (((Xe8-Xc)/Xc)*100),
         percent_change9 = (((Xe9-Xc)/Xc)*100),
         percent_change10 = (((Xe10-Xc)/Xc)*100))

# This is doing the same thing as analyte_table_means chunk but adding in the multiple controls for study_ID_12

brie_test <- MeanConcTest %>% 
  filter(Study_ID == "12") %>% 
  group_by(Study_ID, response_var, Koppen, TSF) %>%
  summarize(Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
            Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
            Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
            Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
            Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
            Xc123 = sum(Xc[Pair_JSC == "Control 1, 2, and 3"], na.rm = TRUE),
            Xc4 = sum(Xc[Pair_JSC == "Control 4"], na.rm = TRUE),
            Xc5 = sum(Xc[Pair_JSC == "Control 5"], na.rm = TRUE)) 

# This is doing the same as analyte_table_percent_change but for study_ID_12
# I am also adding columns to match the columns to ultimately combine analyte_table_percent_change with this below chunk that does the stats for study_ID_12
brie_test_stats <- brie_test %>% 
  group_by(Study_ID, response_var, Koppen, TSF) %>%
  mutate(percent_change1 = (((Xe1-Xc123)/Xc123)*100),
         percent_change2 = (((Xe2-Xc123)/Xc123)*100),
         percent_change3 = (((Xe3-Xc123)/Xc123)*100),
         percent_change4 = (((Xe4-Xc4)/Xc4)*100),
         percent_change5 = (((Xe5-Xc5)/Xc5)*100)) %>% 
  add_column(Ne = NA,
             Nc = NA,
             Xe6 = NA,
             Xe7 = NA,
             Xe8 = NA,
             Xe9 = NA,
             Xe10 = NA,
             Xc = NA,
             percent_change6 = NA,
             percent_change7 = NA,
             percent_change8 = NA,
             percent_change9 = NA,
             percent_change10 = NA) %>% 
  ungroup()

# Adding columns to match brie_test_stats
analyte_table_percent_change <-analyte_table_percent_change %>% 
  add_column(Xc123 = NA,
             Xc4 = NA,
             Xc5 = NA) %>% 
  ungroup()

# combining study_ID_12 back into the mix 
analyte_table_combine <- analyte_table_percent_change %>% 
  add_row(brie_test_stats)

## Study_ID_9 ##
# Study_ID 9 is not working properly, so let me try and fix it here: #
study_9 <- MeanConcTest %>% 
  filter(Study_ID == 9) %>% 
  filter(response_var == "DOC_mg_C_L" | 
         response_var == "NO3_mg_per_L_as_Nitrate")

analyte_table_means_9 <- study_9 %>% 
  select(-Pair_JSC) %>%
  group_by(Study_ID, response_var, Koppen, TSF) %>%
  summarize(Ne = sum(Ne),
            Nc = sum(Nc),
            Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
            Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
            Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
            Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
            Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
            Xe6 = sum(Xe[Pair_JSC == "Site 6"], na.rm = TRUE),
            Xe7 = sum(Xe[Pair_JSC == "Site 7"], na.rm = TRUE),
            Xe8 = sum(Xe[Pair_JSC == "Site 8"], na.rm = TRUE),
            Xe9 = sum(Xe[Pair_JSC == "Site 9"], na.rm = TRUE),
            Xe10 = sum(Xe[Pair_JSC == "Site 10"], na.rm = TRUE),
            Xc = sum(Xc[Pair_JSC == "Control"], na.rm = TRUE)) 

analyte_table_means_9$Xc[analyte_table_means_9$response_var == "DOC_mg_C_L" &
                                                  analyte_table_means_9$Xc=="0"]<- 2.14

analyte_table_means_9$Xc[analyte_table_means_9$response_var == "NO3_mg_per_L_as_Nitrate" &
                                                  analyte_table_means_9$Xc=="0"]<- 0.006774194

analyte_table_means_9[analyte_table_means_9 == 0] <- NA

percent_change_9 <- analyte_table_means_9 %>% 
  group_by(Study_ID, response_var, Koppen, TSF) %>%
  mutate(percent_change1 = (((Xe1-Xc)/Xc)*100),
         percent_change2 = (((Xe2-Xc)/Xc)*100),
         percent_change3 = (((Xe3-Xc)/Xc)*100),
         percent_change4 = (((Xe4-Xc)/Xc)*100),
         percent_change5 = (((Xe5-Xc)/Xc)*100),
         percent_change6 = (((Xe6-Xc)/Xc)*100),
         percent_change7 = (((Xe7-Xc)/Xc)*100),
         percent_change8 = (((Xe8-Xc)/Xc)*100),
         percent_change9 = (((Xe9-Xc)/Xc)*100),
         percent_change10 = (((Xe10-Xc)/Xc)*100))

analyte_table_combine <- analyte_table_combine %>% 
  add_row(percent_change_9)


# Adding a broader climate variable that will group the codes into climates that people actually understand #
unique(analyte_table_combine$Koppen)

analyte_table_combine <- analyte_table_combine %>% 
  mutate(analyte_table_combine, Climate = ifelse(grepl("Dfb|Dfc|Dsc", Koppen), "Cold",
                              ifelse(grepl("Cfb|Csa|Csb", Koppen), "Temperate",
                              ifelse(grepl("BSk", Koppen), "Arid",
                              ifelse(grepl("As|Af|Am", Koppen), "Tropical",
                              ifelse(grepl("ET|EF", Koppen), "Polar", "Other"))))))


# export dataframe 
write.csv(analyte_table_combine, "~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/Output_for_analysis/analyte_table.csv", row.names=FALSE)


# pivoting to make the responses in one column
analyte_table_long <- analyte_table_combine %>% 
  pivot_longer(
    cols = percent_change1:percent_change10,
    names_to = "Site",
    values_to = "Percent_Difference",
    values_drop_na = TRUE
  )

# filter out the only analytes that we want to include in the figure 
analyte_table_filter <- analyte_table_long %>% 
  filter(response_var == "DOC_mg_C_L"| response_var == "NO3_mg_per_L_as_Nitrate") %>% 
  filter(Percent_Difference < 3000)

# export dataframe 
write.csv(analyte_table_filter, "~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/Output_for_analysis/analyte_table_DOC_no3.csv", row.names=FALSE)

# I want to pivot_longer to make all means in one column
# pivoting to make the responses in one column
analyte_table_long_2 <- analyte_table_filter %>% 
  pivot_longer(
    cols = Xe1:Xc5,
    names_to = "Stats",
    values_to = "Value",
    values_drop_na = TRUE
  )

# Calculating the average percent difference per study_ID and the standard deviation:
study_id_summary <- analyte_table_filter %>%
  group_by(Study_ID, response_var) %>%
  summarise(
    Percent_difference = mean(Percent_Difference),
    sd = sd(Percent_Difference, na.rm = TRUE))

# Calculating the standard deviation for all of the percent_differences
# calculating the mean percent_difference by climate 
climate.summary <- analyte_table_filter %>%
  group_by(Koppen, response_var, Climate) %>%
  summarise(
    sd = sd(Percent_Difference, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )



# Calculating the standard deviation for all of the means 
# calculating the mean percent_difference by TSF
climate.TSF.summary <- analyte_table_filter %>%
  group_by(Koppen, response_var, Climate, TSF) %>%
  summarise(
    sd = sd(Percent_Difference, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )

# Calculating the standard deviation for all of the means 
# calculating the mean percent_difference by TSF
TSF.summary <- analyte_table_filter %>%
  group_by(TSF, response_var) %>%
  summarise(
    sd = sd(Percent_Difference, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )


# Average percent difference for DOC 
DOC_average_PC<- analyte_table_filter %>% 
  filter(response_var == "DOC_mg_C_L")

mean(DOC_average_PC$Percent_Difference) # 39.06%
range(DOC_average_PC$Percent_Difference) # -60.75 - 119.78

# Average percent difference for nitrate 
NO3_average_PC<- analyte_table_filter %>% 
  filter(response_var == "NO3_mg_per_L_as_Nitrate")

mean(NO3_average_PC$Percent_Difference) # 183.2567 %
range(NO3_average_PC$Percent_Difference) # -94.73684 - 807 %

# calculate how many watersheds were analyzed in total 
analyte_table_long_2 %>% 
  group_by(Study_ID) %>% 
  n_distinct(analyte_table_long_2$Stats)

n_distinct(analyte_table_long_2$Stats)

```


### STEP 3 Plotting ###
```{r plots}
# Plotting just for DOC - Sophia's poster # 
climate.summary.DOC <- climate.summary %>% 
  filter(response_var == "DOC_mg_C_L")
# geom_jitter for climate # 
ggplot(DOC_average_PC, aes(Percent_Difference, Koppen, color = response_var),
              position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4, size = 3) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), size = 1.5, data = climate.summary.DOC) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  xlim(-100, 350) +
  ylab("Koppen (Climate Classification)") +
  xlab("Percent Difference (%)") +
  geom_segment(aes(x = 200, xend = 200, y = 5.5, yend = 3.5), color = "black") +
  geom_segment(aes(x = 175, xend = 200, y = 5.5, yend = 5.5), color = "black") +
  geom_segment(aes(x = 175, xend = 200, y = 3.5, yend = 3.5), color = "black") +
  
  geom_segment(aes(x = 200, xend = 200, y = 3.3, yend = 0.5), color = "black") +
  geom_segment(aes(x = 175, xend = 200, y = 3.3, yend = 3.3), color = "black") +
  geom_segment(aes(x = 175, xend = 200, y = 0.5, yend = 0.5), color = "black") +
   
  annotate("text",
           x = c(250, 265),
           y = c(4.5, 2),
           label = c("Cold", "Temperate"),
           size = 9,
           family = "", fontface = "bold") +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC')) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 30),
        axis.text.y = element_text(size = 30),
        axis.title.x = element_text(size = 40),
        axis.title.y = element_text(size = 35),
        legend.title = element_text(size = 30),
        legend.text = element_text(size = 30),
        legend.position = c(0.9, 0.65))

ggsave("sophia.poster.DOC.figure.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 10, height = 8, units = "in")
###



# Ploting #
vn = expression(paste(""*N*O[3]^"-"))

give.n <- function(x){
  return(c(y = median(x)*1.05, label = length(x))) 
  # experiment with the multiplier to find the perfect position
}

# geom_jitter for climate # 
ggplot(analyte_table_filter, aes(Percent_Difference, Koppen, color = response_var),
              position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4, size = 3) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), size = 1.5, data = climate.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  xlim(-100, 700) +
  ylab("Koppen (Climate Classification)") +
  xlab("Percent Difference (%)") +
  geom_segment(aes(x = 500, xend = 500, y = 6.5, yend = 4.5), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 6.5, yend = 6.5), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 4.5, yend = 4.5), color = "black") +
  
  geom_segment(aes(x = 500, xend = 500, y = 4.3, yend = 1.5), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 4.3, yend = 4.3), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 1.5, yend = 1.5), color = "black") +
   
  geom_segment(aes(x = 500, xend = 500, y = 1.3, yend = 0.5), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 1.3, yend = 1.3), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 0.5, yend = 0.5), color = "black") +
  annotate("text",
           x = c(550, 550, 550),
           y = c(5.5, 3, 1),
           label = c("Cold", "Temperate", "Arid"),
           family = "", fontface = "bold") +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  scale_x_continuous(breaks = seq(0, 500, by = 50)) + 
  stat_summary(fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 30, angle = -90),
        axis.text.y = element_text(size = 30),
        axis.title.x = element_text(size = 40),
        axis.title.y = element_text(size = 34),
        legend.text = element_text(size = 30),
        legend.position = c(0.9, 0.65))

ggsave("site.difference.geom_pointrange.climate.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 10, height = 8, units = "in")

# Dfc: n = 4,
# Dfb: n = 3,
# Csb: n = 3, 
# Csa: n = 1,
# Cfb: n = 3,
# BSk: n = 2








# geom_jitter for TSF # 
# Creating an order in which I want to plot the y-axis
level_order <- c('0-1 years', '2-3 years', '4-5 years', '>10 years') 

ggplot(analyte_table_filter, aes(Percent_Difference, TSF, color = response_var)) +
  geom_jitter(position = position_jitter(0.2), alpha = 0.4, size = 3) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), size = 1.5, data = TSF.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  scale_y_discrete(limit = level_order) +
  xlim(-100, 850) +
  xlab("Percent Difference (%)") +
  ylab("Time Since Fire") +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  scale_x_continuous(breaks = seq(0, 800, by = 100)) + 
  stat_summary(fun.data = give.n, geom = "text", fun.y = median,
                  position = position_dodge(width = 0.75)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 30, angle = -90),
        axis.text.y = element_text(size = 30),
        axis.title.x = element_text(size = 40),
        axis.title.y = element_text(size = 40),
        legend.title = element_text(size = 30),
        legend.text = element_text(size = 30),
        legend.position = c(0.6, 0.8))

ggsave("site.difference.geom_pointrange.TSF.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 10, height = 8, units = "in")

# > 10 years: n = 2,
# 4-5 years: n = 3,
# 2-3 years: n = 5, 
# 0-1 years: n = 13


# boxplot grouped by Climate #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = Climate, fill = response_var)) +
  geom_boxplot() +
  geom_jitter(shape=16, position=position_jitter(0.2)) +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  xlab("Percent Difference") +
  ylab("") +
  xlim(-100, 700) + 
  scale_fill_brewer(palette="Set1",
                    guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 20),
        axis.text.x = element_text(size = 20),
        axis.title.x = element_text(size = 25))

ggsave("Climate.sites.difference.box.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 10, height = 8, units = "in")

# boxplot grouped by TSF #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y=TSF, fill = response_var)) +
  geom_boxplot() +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  xlab("Percent Difference") +
  ylab("") +
  xlim(-100, 700) + 
  scale_fill_brewer(palette="Set1",
                    guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 20),
        axis.text.x = element_text(size = 20),
        axis.title.x = element_text(size = 25))

ggsave("TSF.sites.difference.box.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 10, height = 8, units = "in")


# boxplot with all the sites in one box 
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = response_var, fill = response_var)) +
  geom_boxplot() +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  xlab("Percent Difference") +
  ylab("") +
  theme(axis.text.y = element_blank()) +
  scale_fill_brewer(palette="Set1") +
  facet_wrap(~Study_ID, scales = "free") +
  theme_classic()

ggsave("all.sites.difference.box.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 25, height = 20, units = "in")

# boxplot with sites broken up #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = response_var, fill = response_var)) +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  geom_boxplot() +
  xlab("Difference") +
  ylab("") +
  xlim(-2.5, 2.5) +
  theme(axis.text.y = element_blank()) +
  scale_fill_brewer(palette="Set1") +
  facet_wrap(~Study_ID, scales = "free") +
  theme_classic()

ggsave("test.site.difference.box.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 25, height = 20, units = "in")


```























```{r graveyard}

# geom_jitter for climate and TSF # 
ggplot(analyte_table_filter, aes(Percent_Difference, Koppen, shape = TSF, color = response_var),
              position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4, size = 3) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5),  , data = climate.TSF.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  xlim(-100, 700) +
  ylab("Koppen (Climate Classification)") +
  xlab("Percent Difference (%)") +
  geom_segment(aes(x = 500, xend = 500, y = 6.5, yend = 4.5), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 6.5, yend = 6.5), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 4.5, yend = 4.5), color = "black") +
  
  geom_segment(aes(x = 500, xend = 500, y = 4.3, yend = 1.5), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 4.3, yend = 4.3), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 1.5, yend = 1.5), color = "black") +
   
  geom_segment(aes(x = 500, xend = 500, y = 1.3, yend = 0.5), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 1.3, yend = 1.3), color = "black") +
  geom_segment(aes(x = 475, xend = 500, y = 0.5, yend = 0.5), color = "black") +
  annotate("text",
           x = c(550, 550, 550),
           y = c(5.5, 3, 1),
           label = c("Cold", "Temperate", "Arid"),
           family = "", fontface = "bold") +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

ggsave("site.difference.geom_pointrange.climate.TSF.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 10, height = 8, units = "in")

# geom_jitter for climate facet # 
ggplot(analyte_table_filter, aes(Percent_Difference, Koppen, color = response_var),
              position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), data = climate.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  facet_grid(~Climate ~ .) +
  xlim(-100, 700) +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic()

ggsave("site.difference.geom_pointrange.climate.facet.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 10, height = 8, units = "in")

# attempt to do shading in the background # 
ggplot(analyte_table_filter, aes(Percent_Difference, Koppen),
              position = position_dodge(width = -0.5)) +
  geom_jitter(aes(color = response_var),
              position = position_jitter(0.1), alpha = 0.4) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = Koppen, ymax = dplyr::lead(Koppen), fill = Climate), 
                      alpha = 0.3, data = climate.summary) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), data = climate.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  xlim(-100, 700) +
  scale_fill_manual(values = c("#D55E00", "#56B4E9", "#009E73")) +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  
theme_classic()



ggsave("site.difference.geom_pointrange.climate.shading.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/initial_plots/01_Wenas_lit_review_figure"),
       width = 10, height = 8, units = "in")

# other attempts that may be useful #
# Plots attempts # 
# pointplot with sd attempt #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = response_var, color = Site, shape = response_var)) +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  geom_point() +
  geom_errorbar(aes(xmin=Xe1-Sd1, xmax=Xe1+Sd1),
                linewidth = 0.2, color = "black", alpha = 0.9, size = 1.0)+
  xlab("Percent Difference") +
  ylab("") +
  theme(axis.text.y = element_blank()) +
  scale_color_brewer(palette="Set1") +
  facet_wrap(~Study_ID, scales = "free") +
  theme_classic()

ggsave("test.site.difference.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 25, height = 20, units = "in")

# geom_pointrange grouped by Climate #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = Climate, xmin = Xe1-Sd1, xmax = Xe1+Sd1)) +
  geom_point() +
  geom_errorbarh(height=.2) +
  xlim(-100, 500) 


df.summary <- analyte_table_filter %>%
  group_by(Climate) %>%
  summarise(
    sd = sd(Xc/Xe1, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )

df.summary

# calculating standard deviation  #
# with sd
# analyte_table_test2 <- MeanConcTest %>%
#   select(-Pair_JSC) %>%
#   group_by(Study_ID, response_var, Climate, TSF) %>%
#   summarize(Ne = sum(Ne),
#             Nc = sum(Nc),
#             Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
#             Sd1 = sum(Sde[Pair_JSC == "Site 1"], na.rm = TRUE),
#             Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
#             Sd2 = sum(Sde[Pair_JSC == "Site 2"], na.rm = TRUE),
#             Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
#             Sd3 = sum(Sde[Pair_JSC == "Site 3"], na.rm = TRUE),
#             Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
#             Sd4 = sum(Sde[Pair_JSC == "Site 4"], na.rm = TRUE),
#             Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
#             Sd5 = sum(Sde[Pair_JSC == "Site 5"], na.rm = TRUE),
#             Xe6 = sum(Xe[Pair_JSC == "Site 6"], na.rm = TRUE),
#             Sd6 = sum(Sde[Pair_JSC == "Site 6"], na.rm = TRUE),
#             Xe7 = sum(Xe[Pair_JSC == "Site 7"], na.rm = TRUE),
#             Sd7 = sum(Sde[Pair_JSC == "Site 7"], na.rm = TRUE),
#             Xe8 = sum(Xe[Pair_JSC == "Site 8"], na.rm = TRUE),
#             Sd8 = sum(Sde[Pair_JSC == "Site 8"], na.rm = TRUE),
#             Xe9 = sum(Xe[Pair_JSC == "Site 9"], na.rm = TRUE),
#             Sd9 = sum(Sde[Pair_JSC == "Site 9"], na.rm = TRUE),
#             Xe10 = sum(Xe[Pair_JSC == "Site 10"], na.rm = TRUE),
#             Sd10 = sum(Sde[Pair_JSC == "Site 10"], na.rm = TRUE),
#             Xc = sum(Xc[Pair_JSC == "Control"], na.rm = TRUE),
#             Sdc = sum(Sdc[Pair_JSC == "Control"], na.rm = TRUE))


# mutate(diff1 = Xe1 - Xc,
  #        diff2 = Xe2 - Xc,
  #        diff3 = Xe3 - Xc,
  #        diff4 = Xe4 - Xc,
  #        diff5 = Xe5 - Xc,
  #        diff6 = Xe6 - Xc,
  #        diff7 = Xe7 - Xc,
  #        diff8 = Xe8 - Xc,
  #        diff9 = Xe9 - Xc,
  #        diff10 = Xe10 - Xc) 

# By treatment and by response_var #
# By DOC
BurnDOC <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "DOC_mg_C_L")

names(BurnDOC) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnDOC <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "DOC_mg_C_L")

names(UnburnDOC) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

DOC_table <- full_join(BurnDOC, UnburnDOC, by = c("Study_ID", "response"))

# By nitrate
BurnNO3 <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "NO3_mg_per_L_as_Nitrate")

names(BurnNO3) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnNO3 <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "NO3_mg_per_L_as_Nitrate")

names(UnburnNO3) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

NO3_table <- full_join(BurnNO3, UnburnNO3, by = c("Study_ID", "response"))

# By TN
BurnTN <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "TN_mg_N_per_L")

names(BurnTN) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnTN <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "TN_mg_N_per_L")

names(UnburnTN) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

TN_table <- full_join(BurnTN, UnburnTN, by = c("Study_ID", "response"))

# By NH4
BurnNH4 <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "NH4_mg_per_L_as_NH4")

names(BurnNH4) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnNH4 <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "NH4_mg_per_L_as_NH4")

names(UnburnNH4) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

NH4_table <- full_join(BurnNH4, UnburnNH4, by = c("Study_ID", "response"))

# By TDN
BurnTDN <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "TDN_mg_N_per_L")

names(BurnTDN) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnTDN <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "TDN_mg_N_per_L")

names(UnburnTDN) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

TDN_table <- full_join(BurnTDN, UnburnTDN, by = c("Study_ID", "response"))

# calculating ln([R])/changes in richness
# DOC
DOC_table <- DOC_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)
# NO3 
NO3_table <- NO3_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)

# TN
TN_table <- TN_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)

# NH4
NH4_table <- NH4_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)

# TDN
TDN_table <- TDN_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)


MeanConcTest <- metadata_long %>% 
  group_by(Study_ID, Treatment, response_var, Climate) %>% 
  dplyr::summarize(Ne = sum(Treatment == "Burn"),
                   Nc = sum(Treatment == "Unburn"),
                   Xe = mean(mean_concentration[Treatment == "Burn"], na.rm = TRUE),
                   Xc = mean(mean_concentration[Treatment == "Unburn"], na.rm = TRUE))

MeanConcWide <- MeanConcTest %>% 
  pivot_wider(names_from = response_var, values_from = c(Xe, Xc))

# By treatment and by response_var #
# By DOC
BurnDOC <- MeanConcTest %>% 
  filter(Treatment == "Burn" & response_var == "DOC_mg_C_L")


# If else attempts # 
MeanConcTest <- MeanConc
unique(MeanConcTest$Treatment)
MeanConcTest$Ne <- ifelse(MeanConcTest$Treatment == 'Burn', print(MeanConcTest$N), ifelse(MeanConcTest$Treatment == 'Unburn', NA, 'Big'))

MeanConcTest$Nc <- ifelse(MeanConcTest$Treatment == 'Unburn', print(MeanConcTest$N), ifelse(MeanConcTest$Treatment == 'Burn', NA, 'Big'))
  


MeanConc <- metadata_long %>%
  group_by(Study_ID, Treatment, response_var, Climate) %>%
  dplyr::summarize(N = n(),
                   X = mean(mean_concentration, na.rm = TRUE))




MeanConcWide <- MeanConc %>% 
  pivot_wider(names_from = response_var, values_from = X)

MeanConcWideTest <- MeanConc %>% 
  pivot_wider(names_from = Treatment, values_from = N) %>% 
  pivot_wider(names_from = response_var, values_from = X)

MeanConcWideTest2 <- MeanConc %>% 
  pivot_wider(names_from = Treatment, values_from = N)

Table1 <- MeanConcWideTest2 %>% 
  group_by(Study_ID, response_var) %>% 
  dplyr::summarize(ratio = )
  

# By treatment #
Burn <- MeanConcWide %>% 
  filter(Treatment == "Burn")
                   
names(Burn) <- c("Study_ID", "Treatment", "Ne", "XeDOC", "XeNH4", "XeNO3", "SDdocE", "XeTN", "SEdocE",
                 "SDtnE", "SEno3E", "SDno3E", "SEnh4E") 
Unburn <- MeanConcWide %>% 
  filter(Treatment == "Unburn")
                   
names(Unburn) <- c("Study_ID", "Treatment", "Nc", "XcDOC", "XcNH4", "XcNO3", "SDdocC", "XcTN", "SEdocC", "SDtnC", "SEno3C", "SDno3C", "SEnh4C") # renaming the column headers to match that of the chem file 



Table1 <- full_join(Burn, Unburn, by = c("Study_ID"))

# select the columns that I want 
Table1 <- Table1[c("Study_ID", "Treatment", "Ne", "Nc", "XeDOC", "XeNH4", "XeNO3", "SDdocE",    "XeTN", "SEdocE", "SDtnE", "SEno3E", "SDno3E", "SEnh4E", "XcDOC", "XcNH4", "XcNO3", "SDdocC", "XcTN", "SEdocC", "SDtnC", "SEno3C", "SDno3C", "SEnh4C")]

table_long <- Table1 %>% 
  pivot_longer(
    cols = XeDOC:SEnh4C,
    names_to = "response_var",
    values_to = "mean_concentration",
    values_drop_na = TRUE
  )


Table2 <- Table1 %>% 
  group_by(Study_ID) %>% 
  mutate(percentDOC = ((1-(XeDOC/XcDOC))*100),
         percentNO3 = ((1-(XeNO3/XcNO3))*100),
         percentNH4 = ((1-(XeNH4/XcNH4))*100))

# Table3 <- table_long %>% 
#   group_by(Study_ID) %>% 
#   mutate(output = XeDOC/XcDOC)

```















